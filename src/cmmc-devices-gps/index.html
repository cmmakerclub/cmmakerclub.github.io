<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>CMMC Devices GPS</title>
    <style>
        /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
        #map {
            height: 100%;
        }

        /* Optional: Makes the sample page fill the window. */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.2/mqttws31.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
</head>
<body>
<div id="map"></div>

<script type="text/javascript">

  var locations = []

  function initMap () {
    var markers
    var markerClusterer
    var map = new google.maps.Map(document.getElementById('map'), {
      zoom: 12,
      center: new google.maps.LatLng(7.924533332999999, 98.37156)
    })

    if (locations.length > 0) {

      markers = locations.map(function (location, i) {

        return new google.maps.Marker({
          position: new google.maps.LatLng(locations[i][1], locations[i][2]),
          label: locations[i][0]
        })
      })

      markerClusterer = new MarkerClusterer(map, markers,
        {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'})
    }

  }

  const init = {
    hostname: 'mqtt.cmmc.io',
    port: 9001,
    path: '',
    clientId: String(Math.random() * 100)
  }

  const options = {useSSL: false, onSuccess: onConnect}

  const client = new Paho.MQTT.Client(init.hostname, init.port, init.path, init.clientId)

  client.onConnectionLost = onConnectionLost
  client.onMessageArrived = onMessageArrived
  client.connect(options)

  function onConnect () {
    console.log('mqtt connection ok.')
    client.subscribe('retain/WORK/TRAFFY_V3/TEST/#')
  }

  function onConnectionLost (responseObject) {
    console.log('connection lost...')
    if (responseObject.errorCode !== 0) {
      console.log('onConnectionLost:' + responseObject.errorMessage)
    }
  }

  function onMessageArrived (message) {
    var d = JSON.parse(message.payloadString)
    var deviceName = d.linkit
    locations.push([deviceName.substr(-4), d.gps_latitude, d.gps_longitude])
    _.uniq(locations, function (device) {
      return device[0]
    })
    initMap()
  }
</script>

<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBvghnsRUrMhoVlgnTCGkG3WB0nZibaxzE&callback=initMap">
</script>
</body>
</html>
